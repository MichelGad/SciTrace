{% extends "base.html" %}

{% block title %}Dataflows - SciTrace{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <div class="me-3">
                <i class="fas fa-share-alt text-primary fs-1"></i>
            </div>
            <div>
                <h2 class="fw-bold mb-1">Dataflows</h2>
                <p class="text-muted mb-0">Visualize your research data workflows</p>
            </div>
        </div>
        <div class="d-flex gap-2">
            <button id="resetDataflowsBtn" class="btn btn-outline-danger">
                <i class="fas fa-trash me-1"></i>
                Reset Dataflows
            </button>
            <a href="{{ url_for('dataflow.create') }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>
                Create Dataflow
            </a>
        </div>
    </div>

    <!-- Dataflows Grid -->
    <div class="row">
        {% for dataflow in dataflows %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h5 class="card-title mb-1">{{ dataflow.name }}</h5>
                            <small class="text-muted">Project: {{ dataflow.project.name }}</small>
                        </div>
                        <div class="d-flex gap-2">
                            {% if "Demo" in dataflow.project.name or "Research" in dataflow.project.name %}
                            <span class="badge bg-warning">Demo</span>
                            {% endif %}
                            <span class="badge bg-primary">
                                <i class="fas fa-share-alt me-1"></i>
                                Dataflow
                            </span>
                        </div>
                    </div>
                    
                    <p class="card-text text-muted">
                        {{ dataflow.description[:100] }}{% if dataflow.description|length > 100 %}...{% endif %}
                    </p>
                    
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>
                            Created: {{ dataflow.created_at.strftime('%Y-%m-%d') }}
                        </small>
                    </div>
                    
                    {% set metadata = dataflow.get_metadata() %}
                    {% if metadata %}
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-file me-1"></i>
                            Files: {{ metadata.get('total_files', 0) }}
                        </small>
                        <br>
                        <small class="text-muted">
                            <i class="fas fa-folder me-1"></i>
                            Directories: {{ metadata.get('total_directories', 0) }}
                        </small>
                    </div>
                    {% endif %}
                    
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('dataflow.view', dataflow_id=dataflow.id) }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-folder-tree me-1"></i>
                            Repo View
                        </a>
                        <a href="{{ url_for('dataflow.git_log', dataflow_id=dataflow.id) }}" class="btn btn-outline-warning btn-sm" style="border-color: #f05032; color: #f05032;">
                            <i class="fas fa-code-branch me-1"></i>Git Log
                        </a>
                        <a href="{{ url_for('dataflow.lifecycle_view', dataflow_id=dataflow.id) }}" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-sitemap me-1"></i>
                            Data Lifecycle
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        
        {% if not dataflows %}
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-share-alt fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted mb-3">No dataflows yet</h4>
                    {% if projects %}
                    <p class="text-muted mb-4">You have projects but no dataflows yet. Create a dataflow for one of your projects to visualize your research workflow.</p>
                    {% else %}
                    <p class="text-muted mb-4">Create your first project and dataflow to visualize your research workflow</p>
                    <a href="{{ url_for('projects.create') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>
                        Create Your First Project
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Projects Section -->
    {% if projects %}
    <div class="row mt-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-transparent border-0">
                    <h4 class="mb-0 fw-bold">Your Projects</h4>
                    <p class="text-muted mb-0">Create dataflows for your existing projects</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for project in projects %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="d-flex justify-content-between align-items-center p-3 border rounded">
                                <div>
                                    <h6 class="mb-1">{{ project.name }}</h6>
                                    <small class="text-muted">{{ project.description[:50] }}{% if project.description|length > 50 %}...{% endif %}</small>
                                </div>
                                <a href="{{ url_for('dataflow.create_for_project', project_id=project.id) }}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-plus me-1"></i>
                                    Create Dataflow
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Reset dataflows functionality
$(document).ready(function() {
    $('#resetDataflowsBtn').click(function() {
        if (confirm('This will permanently delete ALL your dataflows. This action cannot be undone. Are you sure you want to continue?')) {
            // Show loading state
            const button = $(this);
            const originalText = button.html();
            button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Resetting...');
            
            // Make AJAX call to reset dataflows
            $.ajax({
                url: '/api/reset-dataflows',
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                success: function(data) {
                    if (data.success) {
                        alert('All dataflows have been reset successfully! Redirecting to dashboard.');
                        window.location.href = '{{ url_for("dashboard.index") }}';
                    } else {
                        alert('Error resetting dataflows: ' + data.error);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    alert('Error resetting dataflows');
                },
                complete: function() {
                    // Restore button state
                    button.prop('disabled', false).html(originalText);
                }
            });
        }
    });
});
</script>
{% endblock %}
