{% extends "base.html" %}

{% block title %}Create Dataflow - SciTrace{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card">
                <div class="card-header bg-transparent border-0">
                    <h3 class="mb-0 fw-bold">
                        <i class="fas fa-plus-circle text-primary me-2"></i>
                        Create Dataflow
                    </h3>
                    <p class="text-muted mb-0">
                        {% if project %}
                        Create a new dataflow for project: {{ project.name }}
                        {% else %}
                        Create a new dataflow for your research workflow
                        {% endif %}
                    </p>
                </div>
                <div class="card-body p-4">
                    <form method="POST" id="dataflow-form">
                        {% if not project %}
                        <div class="mb-3">
                            <label for="project_id" class="form-label fw-medium">Select Project *</label>
                            <select class="form-select" id="project_id" name="project_id" required>
                                <option value="">Choose a project...</option>
                                {% for proj in projects %}
                                <option value="{{ proj.id }}" {% if proj.dataset_path %}data-has-dataset="true"{% endif %}>
                                    {{ proj.name }} {% if not proj.dataset_path %}(No dataset){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Select the project for which you want to create a dataflow</div>
                        </div>
                        {% else %}
                        <input type="hidden" name="project_id" value="{{ project.id }}">
                        {% endif %}
                        
                        <div class="mb-3">
                            <label for="name" class="form-label fw-medium">Dataflow Name *</label>
                            <input type="text" class="form-control" id="name" name="name" required 
                                   placeholder="Enter dataflow name">
                            <div class="form-text">This will be the title of your dataflow visualization</div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="description" class="form-label fw-medium">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="4"
                                      placeholder="Describe your dataflow and research workflow"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="research_type" class="form-label fw-medium">Research Type</label>
                            <select class="form-select" id="research_type" name="research_type">
                                <option value="general">General Research</option>
                                <option value="environmental">Environmental Research</option>
                                <option value="biomedical">Biomedical Research</option>
                                <option value="computational">Computational Research</option>
                            </select>
                            <div class="form-text">Select the research type to determine the dataset structure and sample files</div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="storage_path" class="form-label fw-medium">Storage Location *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="storage_path" name="storage_path" required 
                                       placeholder="Choose where to store your dataflow" readonly>
                                <button type="button" class="btn btn-outline-primary" id="browse-btn">
                                    <i class="fas fa-folder-open me-1"></i>
                                    Browse
                                </button>


                            </div>
                            <div class="form-text">Select the directory where your dataflow and dataset will be stored</div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> The dataflow will be automatically generated from your project's dataset structure. 
                            The research type you select will determine the directory structure created in your DataLad dataset. 
                            Directories will be created empty, ready for you to add your own files.
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" id="create-btn">
                                <i class="fas fa-plus me-1"></i>
                                Create Dataflow
                            </button>
                            <a href="{% if project %}{{ url_for('dataflow.project_dataflows', project_id=project.id) }}{% else %}{{ url_for('dataflow.index') }}{% endif %}" class="btn btn-outline-secondary">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            {% if project %}
            <!-- Project Info -->
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-project-diagram me-2 text-info"></i>
                        Project Information
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Project:</strong> {{ project.name }}</p>
                            <p><strong>ID:</strong> {{ project.project_id }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Status:</strong> 
                                <span class="badge badge-{{ 'done' if project.status == 'completed' else 'ongoing' }}">
                                    {{ project.status.title() }}
                                </span>
                            </p>
                            <p><strong>Dataset Path:</strong> 
                                <code class="small">{{ project.dataset_path or 'Not set' }}</code>
                            </p>
                        </div>
                    </div>
                    
                    {% if project.description %}
                    <div class="mt-3">
                        <strong>Description:</strong>
                        <p class="text-muted">{{ project.description }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <!-- Available Projects Info -->
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-project-diagram me-2 text-info"></i>
                        Available Projects
                    </h5>
                    <p class="text-muted">You have {{ projects|length }} project(s) available for dataflow creation.</p>
                    
                    {% if projects %}
                    <div class="row">
                        {% for proj in projects %}
                        <div class="col-md-6 mb-2">
                            <div class="border rounded p-2">
                                <strong>{{ proj.name }}</strong>
                                <br>
                                <small class="text-muted">
                                    {% if proj.dataset_path %}
                                    <i class="fas fa-check-circle text-success"></i> Has dataset
                                    {% else %}
                                    <i class="fas fa-exclamation-triangle text-warning"></i> No dataset
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        You don't have any projects yet. <a href="{{ url_for('projects.create') }}">Create a project first</a>.
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- File Browser Modal -->
    <div class="modal fade" id="fileBrowserModal" tabindex="-1" aria-labelledby="fileBrowserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fileBrowserModalLabel">
                        <i class="fas fa-folder-open me-2 text-primary"></i>
                        Choose Storage Location
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-home"></i>
                            </span>
                            <input type="text" class="form-control" id="current-path" readonly>
                            <button type="button" class="btn btn-outline-secondary" id="up-btn" title="Go to parent directory">
                                <i class="fas fa-level-up-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Directories</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="create-dir-btn">
                                <i class="fas fa-plus me-1"></i>New Folder
                            </button>
                        </div>
                        <div class="border rounded p-2" style="height: 300px; overflow-y: auto;">
                            <div id="directory-list" class="list-group list-group-flush">
                                <!-- Directories will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Tip:</strong> Choose a location where you have write permissions. 
                        The system will create a new folder for your dataflow within the selected directory.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="select-location-btn">
                        <i class="fas fa-check me-1"></i>
                        Select This Location
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    console.log('Page loaded, JavaScript is working!');
    
    let currentPath = '';
    
    // File browser functionality

    

    
    $('#browse-btn').on('click', function(e) {
        e.preventDefault();
        console.log('Browse button clicked!');
        
        // Check if modal element exists
        const modalElement = $('#fileBrowserModal');
        console.log('Modal element found:', modalElement.length);
        
        if (modalElement.length === 0) {
            console.error('Modal element not found!');
            alert('Modal element not found. Please check the page.');
            return;
        }
        
        // Show the modal
        console.log('Attempting to show modal...');
        modalElement.modal('show');
        console.log('Modal show command executed');
        
        // Start with user's home directory instead of root
        console.log('Loading directories...');
        loadDirectories('/Users/michelgad');
    });
    
    $('#up-btn').on('click', function() {
        if (currentPath && currentPath !== '/') {
            const parentPath = currentPath.split('/').slice(0, -1).join('/') || '/';
            loadDirectories(parentPath);
        }
    });
    
    $('#create-dir-btn').on('click', function() {
        const dirName = prompt('Enter folder name:');
        if (dirName && dirName.trim()) {
            createDirectory(currentPath, dirName.trim());
        }
    });
    
    $('#select-location-btn').on('click', function() {
        $('#storage_path').val(currentPath);
        $('#fileBrowserModal').modal('hide');
    });
    
    function loadDirectories(path) {
        currentPath = path;
        $('#current-path').val(path);
        
        console.log('Loading directories for path:', path);
        
        $.ajax({
            url: '/api/browse-directories',
            method: 'GET',
            data: { path: path },
            xhrFields: {
                withCredentials: true
            },
            success: function(data) {
                console.log('Success response:', data);
                if (data.success) {
                    displayDirectories(data.directories);
                } else {
                    alert('Error loading directories: ' + data.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', xhr.status, error);
                console.error('Response text:', xhr.responseText);
                if (xhr.status === 401 || xhr.status === 403) {
                    alert('Authentication required. Please log in again.');
                } else {
                    alert('Error loading directories. Please try again.');
                }
            }
        });
    }
    
    function displayDirectories(directories) {
        console.log('displayDirectories called with:', directories);
        const $list = $('#directory-list');
        console.log('Directory list element:', $list.length);
        $list.empty();
        
        if (directories.length === 0) {
            console.log('No directories found');
            $list.append('<div class="text-muted text-center py-3">No directories found</div>');
            return;
        }
        
        console.log('Adding', directories.length, 'directories to the list');
        directories.forEach(function(dir, index) {
            console.log('Adding directory:', dir.name, 'at index:', index);
            const $item = $(`
                <div class="list-group-item list-group-item-action d-flex align-items-center" data-path="${dir.path}">
                    <i class="fas fa-folder me-2 text-warning"></i>
                    <span class="flex-grow-1">${dir.name}</span>
                    <small class="text-muted">${dir.permissions}</small>
                </div>
            `);
            
            $item.on('click', function() {
                loadDirectories(dir.path);
            });
            
            $list.append($item);
        });
        
        console.log('Finished adding directories. List now has', $list.children().length, 'items');
    }
    
    function createDirectory(parentPath, dirName) {
        $.ajax({
            url: '/api/create-directory',
            method: 'POST',
            data: JSON.stringify({ 
                parent_path: parentPath, 
                dir_name: dirName 
            }),
            contentType: 'application/json',
            xhrFields: {
                withCredentials: true
            },
            success: function(data) {
                if (data.success) {
                    loadDirectories(parentPath);
                } else {
                    alert('Error creating directory: ' + data.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', xhr.status, error);
                if (xhr.status === 401 || xhr.status === 403) {
                    alert('Authentication required. Please log in again.');
                } else {
                    alert('Error creating directory. Please try again.');
                }
            }
        });
    }
    
    // Form submission
    $('#dataflow-form').on('submit', function(e) {
        // Validate required fields
        const projectId = $('#project_id').val() || $('input[name="project_id"]').val();
        const storagePath = $('#storage_path').val();
        
        if (!projectId) {
            e.preventDefault();
            alert('Please select a project');
            return;
        }
        
        if (!storagePath) {
            e.preventDefault();
            alert('Please select a storage location');
            return;
        }
        
        // Disable button and show loading
        $('#create-btn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Creating...');
        
        // Allow form to submit normally (will handle redirects properly)
    });
    

});
</script>
{% endblock %}
